<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fruitverse — 3D, Themes, Infinite Scroll, APIs</title>
    <meta name="description" content="A single-file 3D fruit explorer with cool themes, smooth animations, infinite scroll, and live API data." />
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0b12;
            --panel: rgba(255,255,255,0.06);
            --panel-strong: rgba(255,255,255,0.12);
            --text: #e9edf6;
            --muted: #b7c0d0;
            --accent: #7dfcff;
            --accent-2: #ff7de8;
            --ring: rgba(125,252,255,0.35);
            --card: rgba(14,18,27,0.65);
            --shadow: 0 20px 40px rgba(0,0,0,0.45);
            --glass: backdrop-filter: blur(10px) saturate(120%);
            --radius: 16px;
            --speed: 320ms;
            --ease: cubic-bezier(.2,.8,.2,1);
        }
            /* Light theme */
            :root.theme-light {
                --bg: #f6f7fb;
                --panel: rgba(0,0,0,0.04);
                --panel-strong: rgba(0,0,0,0.07);
                --text: #151822;
                --muted: #5d6471;
                --accent: #4f7cff;
                --accent-2: #ff6b6b;
                --ring: rgba(79,124,255,0.25);
                --card: #ffffffcc;
                --shadow: 0 10px 30px rgba(24,28,45,0.15);
            }
            /* Neon theme */
            :root.theme-neon {
                --bg: radial-gradient(1200px 600px at 10% 10%, #12091e 0%, #0b0b12 40%, #05060b 100%);
                --panel: rgba(255,255,255,0.08);
                --panel-strong: rgba(255,255,255,0.16);
                --text: #eaf8ff;
                --muted: #9bc2cd;
                --accent: #00ffaa;
                --accent-2: #ff00d4;
                --ring: rgba(0,255,170,0.35);
                --card: rgba(10,12,20,0.7);
                --shadow: 0 30px 60px rgba(0,0,0,0.55);
            }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font: 16px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 3D background canvas layer */
        #bg3d {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        /* Gradient glow layers */
        .glow {
            position: fixed;
            z-index: 0;
            filter: blur(80px);
            opacity: 0.35;
            pointer-events: none;
            mix-blend-mode: screen;
        }

            .glow.g1 {
                width: 50vmax;
                height: 50vmax;
                left: -10vmax;
                top: -10vmax;
                background: radial-gradient(circle at 30% 30%, var(--accent), transparent 55%)
            }

            .glow.g2 {
                width: 45vmax;
                height: 45vmax;
                right: -8vmax;
                bottom: -12vmax;
                background: radial-gradient(circle at 70% 70%, var(--accent-2), transparent 60%)
            }

        /* Top navigation */
        .nav {
            position: sticky;
            top: 0;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.25), transparent);
            border-bottom: 1px solid var(--panel-strong);
            backdrop-filter: blur(8px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

            .brand .logo {
                width: 36px;
                height: 36px;
                border-radius: 10px;
                background: radial-gradient(18px 18px at 50% 40%, var(--accent) 10%, var(--accent-2) 80%);
                box-shadow: 0 6px 20px var(--ring);
                transform: rotate(8deg);
            }

        .tools {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--panel-strong);
            background: var(--panel);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 12px;
            transition: transform var(--speed) var(--ease), box-shadow var(--speed) var(--ease), background var(--speed), border-color var(--speed);
            cursor: pointer;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 18px var(--ring)
            }

            .btn:focus-visible {
                outline: none;
                box-shadow: 0 0 0 3px var(--ring)
            }

        .select {
            appearance: none;
            border: 1px solid var(--panel-strong);
            background: var(--panel);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 12px;
            transition: background var(--speed), border-color var(--speed);
        }

        /* Header hero */
        .hero {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 28px;
            padding: 32px 22px;
            align-items: center;
        }

        .headline {
            background: var(--card);
            border: 1px solid var(--panel-strong);
            border-radius: var(--radius);
            padding: 22px;
            box-shadow: var(--shadow);
            transition: background var(--speed), border-color var(--speed);
        }

            .headline h1 {
                margin: 0 0 8px;
                font-size: clamp(28px, 4vw, 48px);
                line-height: 1.05;
            }

            .headline p {
                margin: 0;
                color: var(--muted)
            }

        .metrics {
            display: flex;
            gap: 14px;
            margin-top: 14px;
        }

        .pill {
            padding: 8px 12px;
            border-radius: 999px;
            background: var(--panel);
            border: 1px solid var(--panel-strong);
            color: var(--muted);
        }

        /* Search + filters */
        .filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .input {
            flex: 1 1 220px;
            border: 1px solid var(--panel-strong);
            background: var(--panel);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 12px;
            transition: background var(--speed), border-color var(--speed);
        }

            .input::placeholder {
                color: var(--muted)
            }

        /* Grid list */
        .grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
            padding: 12px 22px 80px;
        }

        .card {
            grid-column: span 4;
            background: var(--card);
            border: 1px solid var(--panel-strong);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform var(--speed) var(--ease), box-shadow var(--speed) var(--ease), background var(--speed), border-color var(--speed);
            transform-style: preserve-3d;
            will-change: transform;
        }

        @media (max-width: 1000px) {
            .card {
                grid-column: span 6
            }
        }

        @media (max-width: 720px) {
            .card {
                grid-column: span 12
            }
        }

        .card:hover {
            transform: translateY(-4px)
        }

        .card-header {
            position: relative;
            height: 180px;
            overflow: hidden;
        }

            .card-header img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
                transform: scale(1.02);
                transition: transform var(--speed) var(--ease), filter var(--speed);
            }

        .card:hover .card-header img {
            transform: scale(1.06)
        }

        .card-3d {
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            opacity: 0.8;
        }

        .badge {
            position: absolute;
            left: 12px;
            bottom: 12px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.2px;
            backdrop-filter: blur(6px);
        }

        .card-body {
            padding: 12px 12px 14px;
        }

        .title {
            display: flex;
            align-items: baseline;
            gap: 8px;
            font-weight: 700;
            margin: 0 0 4px;
        }

        .subtitle {
            margin: 0;
            color: var(--muted)
        }

        .facts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .fact {
            background: var(--panel);
            border: 1px solid var(--panel-strong);
            border-radius: 10px;
            padding: 8px 10px;
        }

            .fact b {
                color: var(--text)
            }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Infinite loader sentinel */
        .sentinel {
            width: 100%;
            height: 80px;
            display: grid;
            place-items: center;
            color: var(--muted);
        }

        /* Footer */
        footer {
            padding: 40px 22px;
            color: var(--muted);
            text-align: center;
        }

        /* Sweet micro-interactions */
        .tilt {
            transform: perspective(900px) rotateX(var(--rx, 0deg)) rotateY(var(--ry, 0deg)) translateZ(var(--tz, 0px));
        }

        .ringed {
            box-shadow: 0 0 0 0px var(--ring);
        }

            .ringed:focus-visible {
                box-shadow: 0 0 0 3px var(--ring)
            }

        /* Smooth */
        * {
            transition: background var(--speed), color var(--speed), border-color var(--speed)
        }

        /* Hide scrollbar on WebKit for cleaner look */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px
        }

        ::-webkit-scrollbar-thumb {
            background: var(--panel-strong);
            border-radius: 999px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }
    </style>
</head>
<body>
    <canvas id="bg3d"></canvas>
    <div class="glow g1"></div>
    <div class="glow g2"></div>

    <nav class="nav">
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>Fruitverse</div>
        </div>
        <div class="tools">
            <select id="theme" class="select" title="Theme">
                <option value="default">Default</option>
                <option value="light">Light</option>
                <option value="neon">Neon</option>
            </select>
            <input id="search" class="input" type="search" placeholder="Search fruits (e.g., mango, apple, banana)..." />
            <button id="reset" class="btn">Reset</button>
            <button id="shuffle" class="btn">Shuffle</button>
        </div>
    </nav>

    <header class="hero">
        <section class="headline tilt">
            <h1>Explore fruits in 3D with live data, smooth vibes, and infinite scroll.</h1>
            <p>Nutrition facts, origin notes, tree info, curated images, and interactive layers — all in one single file.</p>
            <div class="metrics">
                <div class="pill"><b>Realtime:</b> Fruityvice + Wikipedia + Unsplash (source)</div>
                <div class="pill"><b>FX:</b> Three.js background + tilt + parallax</div>
                <div class="pill"><b>UX:</b> Themes, smooth transitions, infinite scroll</div>
            </div>
            <div class="filters">
                <select id="filter-family" class="select" title="Family">
                    <option value="">All families</option>
                    <option value="Rosaceae">Rosaceae</option>
                    <option value="Musaceae">Musaceae</option>
                    <option value="Rutaceae">Rutaceae</option>
                    <option value="Anacardiaceae">Anacardiaceae</option>
                    <option value="Ericaceae">Ericaceae</option>
                </select>
                <select id="sort" class="select" title="Sort">
                    <option value="name-asc">Name A → Z</option>
                    <option value="name-desc">Name Z → A</option>
                    <option value="calories-asc">Calories low → high</option>
                    <option value="calories-desc">Calories high → low</option>
                    <option value="sugar-asc">Sugar low → high</option>
                    <option value="sugar-desc">Sugar high → low</option>
                </select>
            </div>
        </section>
        <section class="headline tilt">
            <h2 style="margin:0 0 10px">Live highlights</h2>
            <p id="highlights" class="subtitle">Loading fresh fruit data...</p>
            <div id="mini-stats" class="facts"></div>
        </section>
    </header>

    <main id="grid" class="grid" aria-live="polite"></main>
    <div id="sentinel" class="sentinel">Loading more fruits...</div>

    <footer>
        Built with love and layers. Single-file. No build steps. Toggle themes, search away, and scroll into the orchard.
    </footer>

    <!-- Three.js CDN -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script>// ===== Theme handling =====
    const themeSelect = document.getElementById('theme');
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('fruitverse-theme') || 'default';
    applyTheme(savedTheme);
    themeSelect.value = savedTheme;
    themeSelect.addEventListener('change', e => applyTheme(e.target.value));
    function applyTheme(t) {
      root.classList.remove('theme-light','theme-neon');
      if (t === 'light') root.classList.add('theme-light');
      if (t === 'neon') root.classList.add('theme-neon');
      localStorage.setItem('fruitverse-theme', t);
    }

    // ===== 3D background (lightweight fruit-like shapes) =====
    (() => {
      const canvas = document.getElementById('bg3d');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
      camera.position.set(0, 0, 12);

      const ambient = new THREE.AmbientLight(0xffffff, 0.7);
      const key = new THREE.PointLight(0xff88aa, 1.2); key.position.set(8, 6, 8);
      const rim = new THREE.PointLight(0x88ffee, 1.1); rim.position.set(-6, -5, -8);
      scene.add(ambient, key, rim);

      const palette = [
        0xff6b6b, // strawberry
        0xffc15e, // mango
        0xffe66d, // banana
        0x8affc1, // melon
        0x7dfcff, // neon accent
        0xb388ff, // grape
        0x66d17a  // apple-ish green
      ];

      const fruits = [];
      const sphere = new THREE.SphereGeometry(1, 32, 32);
      const ellipsoid = new THREE.SphereGeometry(1.2, 24, 24);
      const torus = new THREE.TorusGeometry(0.9, 0.28, 32, 64);
      for (let i = 0; i < 24; i++) {
        const color = palette[(Math.random()*palette.length)|0];
        const mat = new THREE.MeshStandardMaterial({
          color,
          roughness: 0.35,
          metalness: 0.15,
          emissive: new THREE.Color(color).multiplyScalar(0.12),
        });
        const geo = i%3===0 ? torus : i%3===1 ? ellipsoid : sphere;
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(
          (Math.random()*2-1)*10,
          (Math.random()*2-1)*6,
          (Math.random()*2-1)*6
        );
        mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
        const s = 0.6 + Math.random()*0.8;
        mesh.scale.set(s, s*(i%3===1?0.8:1), s);
        scene.add(mesh);
        fruits.push(mesh);
      }

      function onResize() {
        const w = innerWidth, h = innerHeight;
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        camera.aspect = w/h;
        camera.updateProjectionMatrix();
      }
      addEventListener('resize', onResize);
      onResize();

      let t = 0;
      const mouse = new THREE.Vector2(0,0);
      addEventListener('mousemove', e => {
        mouse.x = (e.clientX / innerWidth)*2 - 1;
        mouse.y = (e.clientY / innerHeight)*2 - 1;
      });

      function animate() {
        requestAnimationFrame(animate);
        t += 0.006;
        fruits.forEach((m, i) => {
          m.rotation.x += 0.002 + i*0.00005;
          m.rotation.y -= 0.003 + i*0.00007;
          m.position.y += Math.sin(t + i)*0.003;
          m.position.x += Math.cos(t*0.7 + i)*0.0015;
        });
        camera.position.x = mouse.x * 0.6;
        camera.position.y = -mouse.y * 0.4;
        camera.lookAt(0,0,0);
        renderer.render(scene, camera);
      }
      animate();
    })();

    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const grid = $('#grid');
    const sentinel = $('#sentinel');
    const search = $('#search');
    const filterFamily = $('#filter-family');
    const sortSel = $('#sort');
    const resetBtn = $('#reset');
    const shuffleBtn = $('#shuffle');
    const miniStats = $('#mini-stats');
    const highlights = $('#highlights');

    function debounce(fn, ms=250) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)) }
    function slug(s) { return s.toLowerCase().replace(/\s+/g,'-') }

    // ===== Data sources (APIs) =====
    // Fruityvice: fruit list + nutrition
    const FRUITS_URL = 'https://www.fruityvice.com/api/fruit/all';
    // Wikipedia summary: tree info via "Fruit tree" heuristic
    const WIKI_SUMMARY = title => `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    // Unsplash Source (no key): curated image by query
    const UNSPLASH = query => `https://source.unsplash.com/featured/?${encodeURIComponent(query)},fruit`;

    // ===== State =====
    let allFruits = [];      // full dataset
    let filtered = [];       // filtered + sorted
    let cursor = 0;          // pagination index
    const PAGE = 12;         // cards per batch

    // ===== Fetch data =====
    async function fetchFruits() {
      const res = await fetch(FRUITS_URL);
      const json = await res.json();
      // normalize shape
      return json.map(x => ({
        id: x.id,
        name: x.name,
        family: x.family,
        order: x.order,
        genus: x.genus,
        nutritions: x.nutritions, // {carbohydrates, protein, fat, calories, sugar}
      }));
    }
    async function fetchTreeInfo(fruitName) {
      const guess = `${fruitName} tree`;
      try {
        const res = await fetch(WIKI_SUMMARY(guess));
        if (!res.ok) throw new Error('wiki');
        const d = await res.json();
        const title = d.title || guess;
        const extract = d.extract || 'Tree info not available.';
        return { title, extract, url: d.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(guess)}` };
      } catch {
        return { title: `${fruitName} tree`, extract: 'Tree info not available.', url: `https://en.wikipedia.org/wiki/${encodeURIComponent(guess)}` };
      }
    }
    function imageFor(fruitName) {
      return UNSPLASH(fruitName);
    }

    // ===== Rendering =====
    function renderStats(list) {
      if (!list.length) { miniStats.innerHTML=''; highlights.textContent='No fruits found.'; return; }
      const avg = (key) => Math.round(list.reduce((s,f)=>s+(f.nutritions?.[key]||0),0)/list.length);
      miniStats.innerHTML = `
        <div class="fact"><b>Count</b><div>${list.length}</div></div>
        <div class="fact"><b>Avg calories</b><div>${avg('calories')}</div></div>
        <div class="fact"><b>Avg sugar</b><div>${avg('sugar')}</div></div>
        <div class="fact"><b>Families</b><div>${new Set(list.map(f=>f.family)).size}</div></div>
      `;
      const richestSugar = [...list].sort((a,b)=>(b.nutritions?.sugar||0)-(a.nutritions?.sugar||0))[0];
      const lowestCal = [...list].sort((a,b)=>(a.nutritions?.calories||0)-(b.nutritions?.calories||0))[0];
      highlights.textContent = `Sweetest: ${richestSugar?.name || '—'} • Lightest: ${lowestCal?.name || '—'} • Tap cards for tree info.`;
    }

    function cardHTML(f) {
      const n = f.nutritions || {};
      const img = imageFor(f.name);
      const family = f.family || '—';
      return `
        <article class="card tilt" tabindex="0" data-id="${f.id}" data-name="${f.name}">
          <div class="card-header">
            <img src="${img}" alt="${f.name} photo" loading="lazy" />
            <canvas class="card-3d"></canvas>
            <span class="badge">${family}</span>
          </div>
          <div class="card-body">
            <h3 class="title">${f.name} <small class="subtitle">(${f.genus || '—'})</small></h3>
            <p class="subtitle">${f.order || ''}</p>
            <div class="facts">
              <div class="fact"><b>Calories</b><div>${n.calories ?? '—'}</div></div>
              <div class="fact"><b>Sugar</b><div>${n.sugar ?? '—'}</div></div>
              <div class="fact"><b>Carbs</b><div>${n.carbohydrates ?? '—'}</div></div>
              <div class="fact"><b>Protein</b><div>${n.protein ?? '—'}</div></div>
            </div>
            <div class="actions">
              <button class="btn ringed" data-action="tree">Tree info</button>
              <button class="btn ringed" data-action="details">Details</button>
            </div>
          </div>
        </article>
      `;
    }

    function mountCards(batch) {
      const frag = document.createDocumentFragment();
      batch.forEach(f => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHTML(f);
        frag.appendChild(wrapper.firstElementChild);
      });
      grid.appendChild(frag);
    }

    async function loadMore() {
      if (cursor >= filtered.length) { sentinel.textContent = 'End of orchard — you saw it all.'; return; }
      const next = filtered.slice(cursor, cursor + PAGE);
      cursor += PAGE;
      mountCards(next);
      enhanceNewCards();
    }

    // ===== Card enhancements: tilt + tiny canvas sparkles =====
    function enhanceNewCards() {
      grid.querySelectorAll('.card').forEach(card => {
        if (card.__enhanced) return;
        card.__enhanced = true;

        // Tilt effect
        card.addEventListener('pointermove', (e) => {
          const r = card.getBoundingClientRect();
          const x = (e.clientX - r.left) / r.width;
          const y = (e.clientY - r.top) / r.height;
          const rx = (0.5 - y) * 6;
          const ry = (x - 0.5) * 8;
          const tz = 18 * (x * (1 - x)) * (y * (1 - y));
          card.style.setProperty('--rx', rx + 'deg');
          card.style.setProperty('--ry', ry + 'deg');
          card.style.setProperty('--tz', tz + 'px');
        });
        card.addEventListener('pointerleave', () => {
          card.style.setProperty('--rx', '0deg');
          card.style.setProperty('--ry', '0deg');
          card.style.setProperty('--tz', '0px');
        });

        // Tiny 3D sparkle canvas overlay
        const cv = card.querySelector('.card-3d');
        const ctx = cv.getContext('2d');
        function resizeCanvas() { cv.width = cv.clientWidth; cv.height = cv.clientHeight; }
        resizeCanvas();
        const dots = Array.from({ length: 40 }, () => ({
          x: Math.random()*cv.width,
          y: Math.random()*cv.height,
          r: Math.random()*1.8+0.4,
          a: Math.random()*0.5+0.15,
          vx: (Math.random()*2-1)*0.25,
          vy: (Math.random()*2-1)*0.25
        }));
        function draw() {
          ctx.clearRect(0,0,cv.width,cv.height);
          for (const d of dots) {
            d.x += d.vx; d.y += d.vy;
            if (d.x<0||d.x>cv.width) d.vx*=-1;
            if (d.y<0||d.y>cv.height) d.vy*=-1;
            const g = ctx.createRadialGradient(d.x, d.y, 0, d.x, d.y, d.r*4);
            g.addColorStop(0, 'rgba(255,255,255,'+d.a+')');
            g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
          }
          requestAnimationFrame(draw);
        }
        draw();
        window.addEventListener('resize', debounce(resizeCanvas, 100));

        // Actions: tree/info
        card.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const name = card.dataset.name;
            if (btn.dataset.action === 'tree') {
              btn.disabled = true; btn.textContent = 'Loading tree...';
              const info = await fetchTreeInfo(name);
              alert(`${info.title}\n\n${info.extract}\n\nLearn more: ${info.url}`);
              btn.disabled = false; btn.textContent = 'Tree info';
            } else {
              const f = allFruits.find(x => x.name === name);
              const n = f?.nutritions || {};
              alert(`${f?.name} details:\nFamily: ${f?.family}\nOrder: ${f?.order}\nGenus: ${f?.genus}\n\nNutrition per 100g:\nCalories: ${n.calories}\nSugar: ${n.sugar} g\nCarbs: ${n.carbohydrates} g\nProtein: ${n.protein} g\nFat: ${n.fat} g`);
            }
          });
        });
      });
    }

    // ===== Filtering, sorting, searching =====
    function applyFilters() {
      const q = (search.value || '').toLowerCase().trim();
      const fam = filterFamily.value;
      filtered = allFruits.filter(f => {
        const matchText = !q || f.name.toLowerCase().includes(q) || f.family.toLowerCase().includes(q) || f.genus.toLowerCase().includes(q) || (f.order||'').toLowerCase().includes(q);
        const matchFam = !fam || f.family === fam;
        return matchText && matchFam;
      });

      const key = sortSel.value;
      const compare = {
        'name-asc': (a,b)=>a.name.localeCompare(b.name),
        'name-desc': (a,b)=>b.name.localeCompare(a.name),
        'calories-asc': (a,b)=>(a.nutritions?.calories||0)-(b.nutritions?.calories||0),
        'calories-desc': (a,b)=>(b.nutritions?.calories||0)-(a.nutritions?.calories||0),
        'sugar-asc': (a,b)=>(a.nutritions?.sugar||0)-(b.nutritions?.sugar||0),
        'sugar-desc': (a,b)=>(b.nutritions?.sugar||0)-(a.nutritions?.sugar||0),
      }[key] || ((a,b)=>a.name.localeCompare(b.name));
      filtered.sort(compare);

      // Reset grid and cursor
      cursor = 0;
      grid.innerHTML = '';
      renderStats(filtered);
      loadMore();
    }

    search.addEventListener('input', debounce(applyFilters, 200));
    filterFamily.addEventListener('change', applyFilters);
    sortSel.addEventListener('change', applyFilters);
    resetBtn.addEventListener('click', () => {
      search.value = '';
      filterFamily.value = '';
      sortSel.value = 'name-asc';
      applyFilters();
    });
    shuffleBtn.addEventListener('click', () => {
      for (let i = filtered.length - 1; i > 0; i--) {
        const j = (Math.random() * (i + 1))|0;
        [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
      }
      cursor = 0; grid.innerHTML=''; loadMore();
    });

    // ===== Infinite scroll via IntersectionObserver =====
    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) loadMore();
      }
    }, { rootMargin: '800px 0px' });
    io.observe(sentinel);

    // ===== Initialize =====
    (async () => {
      try {
        allFruits = await fetchFruits();
      } catch (e) {
        // Offline fallback
        allFruits = [
          { id: 1, name: 'Apple', family: 'Rosaceae', genus: 'Malus', order: 'Rosales', nutritions: { calories: 52, sugar: 10, carbohydrates: 14, protein: 0.3, fat: 0.2 } },
          { id: 2, name: 'Banana', family: 'Musaceae', genus: 'Musa', order: 'Zingiberales', nutritions: { calories: 96, sugar: 12, carbohydrates: 27, protein: 1.3, fat: 0.3 } },
          { id: 3, name: 'Mango', family: 'Anacardiaceae', genus: 'Mangifera', order: 'Sapindales', nutritions: { calories: 60, sugar: 14, carbohydrates: 15, protein: 0.8, fat: 0.4 } },
          { id: 4, name: 'Orange', family: 'Rutaceae', genus: 'Citrus', order: 'Sapindales', nutritions: { calories: 47, sugar: 9, carbohydrates: 12, protein: 0.9, fat: 0.1 } },
          { id: 5, name: 'Strawberry', family: 'Rosaceae', genus: 'Fragaria', order: 'Rosales', nutritions: { calories: 33, sugar: 4.9, carbohydrates: 8, protein: 0.7, fat: 0.3 } },
          { id: 6, name: 'Grapes', family: 'Vitaceae', genus: 'Vitis', order: 'Vitales', nutritions: { calories: 69, sugar: 16, carbohydrates: 18, protein: 0.7, fat: 0.4 } },
        ];
      }
      applyFilters();
    })();</script>
</body>
</html>